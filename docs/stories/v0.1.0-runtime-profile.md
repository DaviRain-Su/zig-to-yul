# Story: v0.1.0 Runtime Profile & Gas Estimation

> 运行时 profile 驱动的动态 gas 估算

## Goals

- 基于 profile 的动态 gas 估算闭环
- 支持本地 VM 与 RPC 采集路径
- 输出可复用的 profile.json

## Acceptance Criteria

### profile.json schema
- [x] 定义并文档化 schema（branches/switches/loops + runs）
- [x] 兼容多轮聚合输出

### Instrumentation
- [x] Yul 生成阶段插桩 branch/switch/loop 计数
- [x] 计数存储布局稳定（memory return）
- [ ] 日志输出布局（logs）
- [ ] 可选择插桩/非插桩构建

### Collection
- [x] 本地 VM 执行采集计数（Anvil + eth_call）
- [x] RPC（eth_call/tx receipt logs）采集计数（eth_call）
- [x] 多轮聚合（hits 累加 + 平均权重）

### Estimation
- [x] `estimate --profile` 读取并应用 overrides
- [x] 估算输出包含 profile 元数据（runs、权重摘要）

### 6.5 SourceLocation
- [x] AST/Transformer 全覆盖 SourceLocation
- [x] SourceMap 输出与 Solidity 格式对齐
- [x] Yul trace 注释输出（--trace）

### 语言体验（语法糖/可读性）
- [x] self.otherMethod() 方法互调
- [x] @as 基础类型转换（Address <-> u256）
- [x] -= / *= 等复合赋值运算
- [x] while (cond) : (i += 1) 语法
- [ ] const/var 基本推导的安全报错提示

### Mapping 与 Zig HashMap 体验对照
- [x] 基础 CRUD（get/set/contains/remove）
- [x] 统计（len/isEmpty/count）
- [x] 扩展 API（getOrPut/getOrPutDefault/putNoClobber/fetchPut）
- [x] 删除语义（removeValue/removeOrNull/removeOrNullInfo）
- [x] 枚举/迭代（keys/values/keyAt/valueAt/iterator/iteratorPtr）
- [x] 指针式接口（getPtr/getOrPutPtr/getOrPutPtrDefault/putNoClobberPtr/fetchPutPtr）
- [x] 清空（clear）
- [!] 容量语义（ensureCapacity/shrinkToFit）为链上占位
- [!] 迭代顺序不稳定（删除时 swap-last）
- [!] 无自定义 hash/eql（链上 slot 规则）

### 5.1 EOF Prague
- [ ] 指令清单与语义实现
- [ ] gas 表更新
- [ ] 测试向量对齐

### CLI/SDK
- [x] CLI：build/deploy/call/profile/abi-gen 子命令
- [x] SDK：storage/abi/event/precompile
- [x] ABI 导出与 Solidity 交互（ABI JSON 输出）
- [x] RPC profiles（name→RPC+chainId）
- [ ] EIP-1559 交易参数与签名

### 优化研究
- [ ] Solady 对比基准与指标
- [ ] mapping/scratch/sload/sstore 优化验证

### 生态整合
- [x] JSON-RPC 兼容（Anvil/Hardhat/Foundry/Alchemy/Infura/QuickNode）
- [x] ABI JSON 输出兼容
- [x] keystore/私钥签名兼容
- [x] SourceMap 格式对齐

### Tests
- [x] 端到端测试：插桩→采集→聚合→估算（z2y profile-test）

## Completion Status

- Start date: 2026-01-10
- Completion date: TBD
- Status: ⏳ In Progress
